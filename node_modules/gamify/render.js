var _ 					= require('underscore');
var file 				= require('./file.js').main;

var cache 				= {};

var caching				= false;

function render(file, data) {
	var i;
	var code	= cache[file]+"";
	
	/*for (i in data) {
		code = code.replace(new RegExp("(\[\[json\:"+i+"\]\])", "ig"), JSON.stringify(data[i]));
		console.log("RegExp",new RegExp("(\[\[json\:"+i+"\]\])", "ig"));
	}*/
	
	// Find the variables
	var regex = new RegExp("{json\:([a-zA-Z0-9-_@]+)}", "igm");
	
	code = code.replace(regex, function(match, expr, pos) {
		if (data[expr]) {
			return JSON.stringify(data[expr]);
		} else {
			return "{}";
		}
		
	});
	
	return code;
}

exports.engine = function(filename, data, callback, Gamify, res, req) {
	if (!cache[file] || !caching) {
		file.read("pages/views/"+filename, function(content) {
			cache[filename] = content;
			callback(render(filename, data));
		});
	} else {
		callback(render(filename, data));
	}
};